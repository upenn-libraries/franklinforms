$(document).ready(function() {

    var $item_select = $("#item_pid");
    if($item_select.prop('nodeName') === 'select') {
        $item_select.select2({
            theme: "bootstrap",
            placeholder: "Click here to make a selection",
            width: "100%"
        }).on('select2:open', function(e){
            $('.select2-search__field').attr('placeholder', 'Start typing to filter the list');
        });
    }

    // show stage2 in modal
    $("#submit-confirm-button").click(function(e) {
        e.preventDefault();
        var selectedOption = $("#item_pid option:selected");
        var form_params = {
            mms_id: document.getElementById("mms_id").value,
            holding_id: document.getElementById("holding_id").value,
            item_pid: $item_select.val(),
            delivery_method: document.getElementById("delivery_method").value,
            issue: selectedOption.data('issue'),
            volume: selectedOption.data('volume'),
            year: selectedOption.data('year')
        }
        $("#confirm-modal").modal({
           remote: '/forms/request/confirm' + '?' + $.param(form_params)
        });
    });

    var $details = $(".dev-details");
    $details.hide();
    $(".show-dev-details").click(function() {
        $(".dev-details").toggle();
    });
});

// clear 'confirm request' boostrap modal when changing delivery method
function clearBootstrapModal() {
    var $confirm_modal = $('#confirm-modal');
    $confirm_modal.removeData('bs.modal');
    $confirm_modal.find('.modal-content').html('');
}
$(document).on('change', '#delivery_method', function(e) {
    clearBootstrapModal();
});

// update delivery options if item selection changes
$(document).on('change', '#item_pid', function(e) {
    var deliverySelect = document.getElementById('delivery_method');
    deliverySelect.disabled = false;
    var selectedDeliveryOption = deliverySelect.options[deliverySelect.selectedIndex]
    deliverySelect.innerHTML = ''
    var selectedItemOption = $("#item_pid option:selected");
    var deliveryOptions = selectedItemOption.data('delivery').split(":");
    deliveryOptions.forEach(function(option) {
        var optionText = deliveryOptionLabel(option);
        var optionElement = document.createElement('option');
        optionElement.text = optionText;
        optionElement.value = option;
        if(optionElement.value === selectedDeliveryOption.value) {
            optionElement.selected = true;
        }
        deliverySelect.appendChild(optionElement);
    });

    // set holding ID if option has holding-id data attrib
    var holdingIdInput = document.getElementById("holding_id");
    if(holdingIdInput) {
        holdingIdInput.value = selectedItemOption.data('holding-id');
    }
    clearBootstrapModal();
});

$(document).on('click', '#confirm_submit_button', function(e) {
    var bbm_validation = document.getElementById('bbm_validation_checkbox');
    if(bbm_validation.validity.valueMissing){
        bbm_validation.setCustomValidity('You must be a registered Books by Mail user to submit this request');
    } else{
        bbm_validation.setCustomValidity('');
    }
});
