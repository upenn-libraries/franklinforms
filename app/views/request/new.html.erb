<% @page_title = 'Request From Penn Libraries' %>
<% bib = @record.bib_object %>

<% original_item_count = @record.items.count %>

<%# filter items %>
<%# items = @record.items  %>
<% items = @record.items.select(&:checkoutable?).select { |i| i.description.present? } %>

<%# sort items %>
<%# items = items.sort_by { |item| [item.item_data['chronology_i'], item.item_data['chronology_j']] } %>

<div class="container">
  <h1>New Patron Request</h1>
  <p>
    You may want to <%= franklin_online_search_link(bib['title']) %>
  </p>
  <dl>
    <dt>Title</dt>
    <dd><%= bib['title'] %></dd>
    <dt>Author</dt>
    <dd><%= bib['author'] %></dd>
  </dl>
  <!-- Item Selection -->
  <%= form_tag create_request_path, method: :post do %>
    <%= hidden_field_tag :mms_id, @record.mms_id, id: 'mms_id' %>
    <%= hidden_field_tag :holding_id, items.first.holding_data['holding_id'], id: 'holding_id' %>
    <% if items.one? %>
      <p>Available for <%= item.delivery_options %></p>
    <%# elsif items.identical_copies? %>
    <% elsif items.count <= 10 %>
      <ol>
        <% items.each do |i| %>
          <li><a href="#"><%= i.label_for_select %></a></li>
        <% end %>
      </ol>
    <% else %>
      <div class="form-group">
        <label for="item_pid_select"><%= items.first.physical_material_type['desc'] %></label>
        <%= select(:item_pid, :select, {}, {}, class: 'select2-bs', id: 'item_pid') do %>
          <% items.each do |i| %>
            <%= content_tag :option, i.label_for_select, value: i.pid, selected: items.first.pid,
                            data: { 'delivery-options': i.delivery_options.join(':'),
                                    'volume': i.volume, 'issue': i.issue,
                                    'year': i.pub_year, 'month': i.pub_month } %>
          <% end %>
      </div>

      <% end %>
    <% end %>
    <div class="form-group">
      <label for="delivery_method_select">Delivery Method</label>
      <%= select(:delivery_method, :select, items.first.delivery_options, {}, { id: 'delivery_method', class: 'form-control' }) %>
    </div>
    <hr>
    <button id="submit-confirm-button" type="button" class="btn btn-primary" data-toggle="modal">Submit</button>
  <% end %>
</div>

<h3>Item Detail Table (dev research only)</h3>

<a href="#" class="show-dev-details">toggle</a>

<div class="dev-details">

  <p>Total Items for Display: <%= items.count %></p>
  <p>Items not displayed: <%= original_item_count - items.count %></p>

  <table class="table table-compact">
    <thead>
    <tr>
      <th>radio label</th>
      <th>select label</th>
      <th>item description</th>
      <th>location name</th>
      <th>item physical material type desc</th>
      <th>enumeration a</th>
      <th>enumeration b</th>
      <th>enumeration c</th>
      <th>chronology i</th>
      <th>chronology j</th>
      <th>chronology k</th>
      <th>checkoutable?</th>
      <th>user due date policy</th>
    </tr>
    </thead>
    <tbody>
    <% items.each do |i| %>
      <tr>
        <td><%= i.label_for_radio_button %></td>
        <td><%= i.label_for_select %></td>
        <td><%= i.description %></td>
        <td><%= i.location_name %></td>
        <td><%= i.physical_material_type['desc'] %></td>
        <td><%= i.item_data['enumeration_a'] %></td>
        <td><%= i.item_data['enumeration_b'] %></td>
        <td><%= i.item_data['enumeration_c'] %></td>
        <td><%= i.item_data['chronology_i'] %></td>
        <td><%= i.item_data['chronology_j'] %></td>
        <td><%= i.item_data['chronology_k'] %></td>
        <td><%= i.checkoutable? %></td>
        <td><%= i.user_due_date_policy %></td>
      </tr>
    <% end %>
    </tbody>
  </table>
</div>

<div class="modal fade" id="confirm-modal">
  <div class="modal-dialog" role="document">
    <div class="modal-content"></div>
  </div>
</div>
